<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no"/>
  <title>è‹±æ–‡æ‹¼å­— Ã— è²éŸ³å°ç…§</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;800&family=Noto+Sans+TC:wght@400;700;800&family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    :root{
      --c-primary:#7c3aed; --c-secondary:#10b981;
      --c-text:#1f2937; --c-bg:#f8fafc; --c-border:#e2e8f0;

      .tag-irregular{background:#fee2e2;border-color:#ef4444;color:#991b1b;}
      .tag-closed{background:#d1fae5;border-color:#10b981;color:#065f46;}
      .tag-floss{background:#ffe4e6;border-color:#fb7185;color:#9f1239;}
      .tag-digraph{background:#e0f2fe;border-color:#38bdf8;color:#075985;}
      .tag-cluster{background:#ede9fe;border-color:#8b5cf6;color:#4c1d95;}
      .tag-suffix{background:#ccfbf1;border-color:#14b8a6;color:#0f766e;}
      .tag-rcontrolled{background:#e9d5ff;border-color:#a855f7;color:#581c87;}
      .tag-open{background:#dcfce7;border-color:#22c55e;color:#14532d;}
      .tag-cle{background:#f5f5f4;border-color:#a8a29e;color:#3f3f46;}
      .tag-magic_e{background:#dbeafe;border-color:#3b82f6;color:#1e40af;}
      .tag-vowel_team{background:#ffedd5;border-color:#f97316;color:#9a3412;}
      .tag-diphthong{background:#dbeafe;border-color:#60a5fa;color:#1e3a8a;}
      .tag-silent_consonant{background:#f1f5f9;border-color:#94a3b8;color:#334155;}
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;overflow-x:hidden}
    body{font-family:"Inter",system-ui,-apple-system,"Noto Sans TC",sans-serif;background:var(--c-bg);color:var(--c-text);padding:1rem 0;line-height:1.6;font-size:18px}
    .container{max-width:1200px;margin:0 auto;padding:1.5rem 1rem;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,.05);min-height:90vh}
    h1{font-family:'Noto Sans TC',sans-serif;font-size:2rem;font-weight:800;color:#0f172a;text-align:center;margin-bottom:2rem}

    /* Page switch */
    .page-section{display:none;min-height:50vh}
    .page-section.active{display:block}
    #homePage{flex-direction:column;align-items:center;justify-content:flex-start}
    #homePage.active{display:flex}
    #homePage:not(.active){display:none!important}

    /* Home list */
    .topic-list{list-style:none;padding:0;width:min(100%,700px);margin-top:2.0rem}
    .topic-list-item{background:#fff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,.05);padding:18px 22px;cursor:pointer;transition:.2s;border-left:5px solid var(--c-secondary);font-size:1.2rem;font-weight:700;color:#1f2937;margin-bottom:1rem;user-select:none;display:block}
    .topic-list-item:hover{background:#f0fdf4;transform:translateX(5px);box-shadow:0 4px 12px rgba(16,185,129,.2);border-color:var(--c-primary)}

    .back-button{background:#eef2ff;color:#4f46e5;border:none;border-radius:12px;padding:10px 18px;font-weight:700;cursor:pointer;font-size:1rem;margin-bottom:1.2rem;transition:.2s;display:flex;align-items:center;gap:8px}
    .back-button:hover{background:#e0e7ff}

    /* Filters & Cards */
    .legend{
      display:flex;
      flex-wrap:wrap;          /* è‡ªå‹•æ›è¡Œ */
      gap:.5rem;               /* é–“è·æ”¹ç”¨ gap */
      padding:0 .25rem .25rem;
      margin:0 0 1.25rem 0;
      list-style:none;
    }
    .legend .legend-item{
      display:inline-flex;
      flex:0 0 auto;
      padding:.3rem .75rem;
      border-radius:999px;
      font-size:.9rem;
      font-weight:700;
      border:2px solid;
      white-space:nowrap;
      cursor:pointer;
      user-select:none;
      transition:transform .1s ease,opacity .2s ease
    }
    .legend .legend-item:hover{transform:scale(1.05)}
    .legend .legend-item.selected{outline:3px solid rgba(14,165,233,.25)}
    .tag-all{background:#e5e7eb;border-color:#94a3b8;color:#334155}
    .category-tag{padding:.3rem .75rem;border-radius:999px;font-size:.9rem;font-weight:700;border:2px solid;white-space:nowrap;user-select:none}

    /* å¡ç‰‡ç¾¤ */
    .topic-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:1.25rem}
    .word-card{border:2px solid #cbd5e1;border-radius:12px;background:#fff;box-shadow:0 4px 6px rgba(0,0,0,.03);overflow:hidden;transition:transform .2s,box-shadow .2s}
    .word-card.hidden{display:none}
    .word-card:hover{transform:translateY(-5px);box-shadow:0 8px 15px rgba(0,0,0,.07)}

    .card-header{display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;background:#f1f5f9;border-bottom:2px solid #e2e8f0}
    .card-title{display:flex;align-items:baseline;gap:.6rem}
    .word-number{font-size:1.1rem;font-weight:700;color:#64748b}
    .word-text{font-size:1.9rem;font-weight:800;color:#0f172a}
    .audio-button{font-size:2rem;cursor:pointer;background:none;border:none;padding:0;line-height:1}

    .card-body{padding:1.1rem; display:flex; flex-direction:column; align-items:center;}

    .badges{display:flex;gap:.5rem;flex-wrap:nowrap;overflow:auto;white-space:nowrap;padding-bottom:.25rem;margin-bottom:.25rem;-webkit-overflow-scrolling:touch}
    .badges .category-tag{flex:0 0 auto}

    .boxes-grid{
      display:grid;
      grid-auto-rows:auto;
      border:2px solid #94a3b8;
      border-radius:8px;
      overflow:auto;
      grid-auto-columns:max-content;
      justify-content:start;
      align-content:start;
      width:max-content;
      max-width:100%;
    }
    .box{display:flex;align-items:center;justify-content:center;min-height:54px;padding:.35rem .5rem;text-align:center;font-size:1.35rem;font-weight:700;border-right:2px solid #cbd5e1}
    .box:last-child{border-right:none}
    .grapheme-box{background:#f1f5f9;color:#1e293b;position:relative;font-family:'Inter','Noto Sans TC',sans-serif;border-bottom:2px solid #cbd5e1;grid-row:1}
    .phoneme-box{background:#fff;color:#475569;font-family:'Noto Sans',sans-serif;font-size:1.15rem;font-weight:400;grid-row:2;transition:.2s}
    .phoneme-box.is-phonics{font-family:'Inter','Noto Sans TC',sans-serif;font-size:1.25rem;color:#0f172a;font-weight:500}
    .heart-symbol{position:absolute;bottom:-2px;left:0;right:0;text-align:center;color:#ef4444;font-size:1rem;line-height:1}
    .word-tips{background:#fef3c7;border:1px solid #fbbf24;border-radius:6px;padding:.5rem .75rem;margin-top:.8rem;font-family:'Noto Sans TC',sans-serif;color:#78350f;font-size:.92rem;line-height:1.4;display:flex;gap:.5rem;align-items:flex-start}
    .tips-icon{color:#f59e0b;font-size:1.1rem}

    /* åˆ‡æ› */
    .toggle-container{display:flex;justify-content:center;align-items:center;gap:1rem;margin-bottom:.4rem;font-weight:700;color:#334155;user-select:none;font-size:1rem}
    .attribution-note{text-align:center;font-size:.85rem;color:#64748b;margin-top:0;margin-bottom:1.1rem;line-height:1.5}
    .attribution-note a{color:#3b82f6;text-decoration:underline}
    .attribution-note a:hover{color:#1d4ed8}
    .toggle-label-ipa,.toggle-label-phonics{color:#64748b;transition:color .2s}
    input:checked ~ .toggle-label-phonics{color:#0f172a}
    input:not(:checked) ~ .toggle-label-ipa{color:#0f172a}
    .switch{position:relative;display:inline-block;width:60px;height:34px;visibility:hidden}
    .switch input{opacity:0;width:0;height:0}
    .slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background:#cbd5e1;transition:.4s;border-radius:34px;visibility:visible}
    .slider:before{position:absolute;content:"";height:26px;width:26px;left:4px;bottom:4px;background:white;transition:.4s;border-radius:50%}
    input:checked + .slider{background:#3b82f6}
    input:checked + .slider:before{transform:translateX(26px)}

    /* footer */
    .credits{margin-top:3rem;padding-top:1.2rem;border-top:2px solid var(--c-border);text-align:center;font-size:.875rem;color:#475569;line-height:1.6}
    .credits a{color:#64748b;margin:0 .5rem;transition:color .2s;text-decoration:none}
    .credits a:hover{color:#3b82f6}

    /* æœå°‹ */
    .searchbar{display:flex;gap:.5rem;align-items:center;justify-content:center;margin:-.3rem auto 1rem;max-width:700px}
    .searchbar input{flex:1;padding:10px 12px;border:2px solid var(--c-border);border-radius:10px;font-size:1rem}
    .searchbar button{background:#111827;color:#fff;border:none;border-radius:10px;padding:10px 14px;font-weight:700;cursor:pointer}
    .searchbar button:hover{opacity:.9}
    .search-msg{margin:.25rem 0 1rem;text-align:center;font-size:.9rem;color:#64748b}
    .word-card.search-hit{outline:3px solid #7c3aed;box-shadow:0 0 0 4px rgba(124,58,237,.15);animation:hitflash 1.6s ease}
    @keyframes hitflash{0%{background:#faf5ff}100%{background:#fff}}

    @media (max-width:768px){
      .container{padding:1rem .5rem}
      h1{font-size:1.6rem}
      .topic-list{width:100%}
      .topic-list-item{font-size:1.05rem;padding:14px 16px}
      .topic-grid{grid-template-columns:1fr}
      .word-text{font-size:1.7rem}
      .box{font-size:1.15rem;min-height:48px}
      .phoneme-box{font-size:1.05rem}
      .phoneme-box.is-phonics{font-size:1.15rem}
      .attribution-note{font-size:.75rem}
      .back-button{margin-bottom:1rem;padding:8px 14px}
    }
  </style>
</head>
<body>
  <div class="container">
    <main>
      <!-- æœå°‹åˆ— -->
      <div class="searchbar" role="search">
        <input id="globalSearchInput" type="text" placeholder="è¼¸å…¥å–®å­—ï¼ˆä¾‹å¦‚ï¼šoneï¼‰" aria-label="æœå°‹å–®å­—">
        <button id="globalSearchBtn">æœå°‹</button>
      </div>
      <p id="searchMsg" class="search-msg" aria-live="polite"></p>

      <!-- é¦–é  / ç›®éŒ„ -->
      <section id="homePage" class="page-section active">
        <h1>è‹±æ–‡æ‹¼å­— Ã— è²éŸ³å°ç…§</h1>
        <ul class="topic-list" id="topicList"><!-- ç”± topics.json å‹•æ…‹ç”¢ç”Ÿ --></ul>
      </section>

      <!-- ä¸»é¡Œ sections æœƒç”± JS å‹•æ…‹æ’å…¥ -->
    </main>

    <footer class="credits">
      Â© 2025 Christina Yu. All rights reserved.<br /><br />
      <a href="mailto:mamahowma@gmail.com" aria-label="Email mamahowma"><i class="fa-solid fa-envelope fa-xl fa-fw"></i></a>ã€€
      <a href="https://www.facebook.com/mamahowma" target="_blank" aria-label="mamahowma Facebook Page"><i class="fa-brands fa-facebook fa-xl fa-fw"></i></a>ã€€
      <a href="https://portaly.cc/mamahowma/support" target="_blank" aria-label="Support mamahowma"><i class="fa-solid fa-mug-hot fa-xl fa-fw"></i></a>
    </footer>
  </div>

  <script>
    // ====== è¨­å®šèˆ‡å¿«å– ======
    const TOPICS_URL = 'data/topics.json';
    const CACHE = { topics: null, data: {} };

    // ====== èªéŸ³ ======
    const synth = window.speechSynthesis; let voices = []; let speechRate = 0.7; // ä½ å–œæ­¡çš„æ…¢é€Ÿ
    function getUSEnglishVoice(){
      if(voices.length===0 && synth.getVoices().length>0){ voices = synth.getVoices().filter(v=>v.lang.startsWith('en')); }
      return voices.find(v=>v.lang==='en-US') || voices[0] || null;
    }
    if(synth.onvoiceschanged!==undefined){ synth.onvoiceschanged = ()=>{ voices = synth.getVoices(); }; }
    window.speak = function(word){
      if(synth.speaking) synth.cancel();
      if(!word) return;
      const u = new SpeechSynthesisUtterance(word);
      const v = getUSEnglishVoice(); if(v) u.voice = v;
      u.lang='en-US'; u.rate=speechRate; u.pitch=1;
      synth.speak(u);
    };

    // ====== ç‹€æ…‹ ======
    let currentTopicData = [];
    let selectedFilter = 'all';
    let displayMode = 'ipa'; // 'ipa' | 'phonics'

    // ====== UI è¼”åŠ© ======
    function tagInfo(key){
      switch(key){
        case 'irregular':        return { className:'tag-irregular',     name:'ä¸è¦å‰‡æ‹¼å¯«' };
        case 'closed':           return { className:'tag-closed',        name:'é–‰éŸ³ç¯€-çŸ­æ¯éŸ³' };
        case 'floss':            return { className:'tag-floss',         name:'é‡è¤‡å­éŸ³å­—å°¾ (FLOSS-Z)' };
        case 'digraph':          return { className:'tag-digraph',       name:'é›™å­—æ¯å­éŸ³' };
        case 'cluster':          return { className:'tag-cluster',       name:'å­éŸ³ç¾¤' };
        case 'suffix':           return { className:'tag-suffix',        name:'å­—å°¾å¾Œç¶´' };
        case 'rcontrolled':      return { className:'tag-rcontrolled',   name:"æ¯éŸ³ + 'r'" };
        case 'open':             return { className:'tag-open',          name:'é–‹éŸ³ç¯€-é•·æ¯éŸ³' };
        case 'cle':              return { className:'tag-cle',           name:"å­éŸ³ '-LE'" };
        case 'magic_e':          return { className:'tag-magic_e',       name:"é•·æ¯éŸ³ + éœéŸ³ 'e'" };
        case 'vowel_team':       return { className:'tag-vowel_team',    name:'æ¯éŸ³çµ„åˆ' };
        case 'diphthong':        return { className:'tag-diphthong',     name:'é›™æ¯éŸ³' };
        case 'silent_consonant': return { className:'tag-silent_consonant', name:'ä¸ç™¼éŸ³å­éŸ³å­—æ¯' };
        default:                 return { className:'tag-all',           name:'æœªåˆ†é¡' };
      }
    }
    function countByFilter(data){
      const counts = {};
      data.forEach(word=>{ (word.tags||[]).forEach(tag=>{ counts[tag] = (counts[tag]||0)+1; }); });
      return counts;
    }

    // ====== ä¸»é¡Œé åˆå§‹åŒ– ======
    function initTopicPage(contentId){
      selectedFilter = 'all';
      const container = document.getElementById(contentId);
      if(container.children.length === 0){
        container.innerHTML = `
          <div class="toggle-container">
            <span class="toggle-label toggle-label-ipa">IPA éŸ³æ¨™</span>
            <label class="switch"><input type="checkbox" id="modeToggle-${contentId}"><span class="slider"></span></label>
            <span class="toggle-label toggle-label-phonics">Phonics æ‹¼éŸ³</span>
          </div>
          <p class="attribution-note">
            IPA æ ¹æ“š<a href="https://christinayu_english.rakosell.com/zh/page/american-ipa-guide" target="_blank">ç¾å¼è‹±èª IPA åœ‹éš›éŸ³æ¨™æŒ‡å—</a><br>
            Phonics æ ¹æ“š <a href="https://ufli.education.ufl.edu/wp-content/uploads/2023/09/UFLI-Sound-Wall-rev.pdf" target="_blank">UFLI phonemes</a>
          </p>
          <ul class="legend" id="category-filters-${contentId}" aria-label="åˆ†é¡ç¯©é¸"></ul>
          <div id="teaching-grid-${contentId}" class="topic-grid" role="region" aria-label="æ•™å­¸å¡ç‰‡æ¸…å–®"></div>
        `;
        const toggle=document.getElementById(`modeToggle-${contentId}`);
        if(toggle){
          toggle.addEventListener('change', e=>{
            displayMode = e.target.checked ? 'phonics' : 'ipa';
            renderTeachingPage(contentId);
            applyFilters(contentId);
          });
          toggle.checked = (displayMode === 'phonics');
        }
      }
      setupCategoryFilters(contentId);
      renderTeachingPage(contentId);
      applyFilters(contentId);
      highlightIfPending(contentId);
    }

    function setupCategoryFilters(contentId){
      const filterList = document.getElementById(`category-filters-${contentId}`);
      if(!filterList) return;
      filterList.innerHTML = '';

      const counts = countByFilter(currentTopicData);

      const allButton = document.createElement('li');
      allButton.className = 'legend-item tag-all';
      allButton.dataset.category = 'all';
      allButton.textContent = 'å…¨éƒ¨';
      filterList.appendChild(allButton);

      const allPossibleTags = ['irregular','closed','floss','digraph','cluster','suffix','rcontrolled','open','cle','magic_e','vowel_team','diphthong','silent_consonant'];
      allPossibleTags.forEach(tagKey=>{
        const info=tagInfo(tagKey);
        const count=counts[tagKey]||0;
        if(count===0) return;
        const li=document.createElement('li');
        li.className=`legend-item ${info.className}`;
        li.dataset.category=tagKey;
        li.textContent=info.name; // ä½ è¦çš„ï¼šä¸é¡¯ç¤ºæ•¸é‡
        filterList.appendChild(li);
      });

      filterList.querySelectorAll('.legend-item').forEach(btn=>{
        btn.addEventListener('click',(e)=>{
          selectedFilter = e.target.dataset.category || 'all';
          updateButtons(filterList);
          applyFilters(contentId);
        });
      });
      updateButtons(filterList);
    }
    function updateButtons(filterList){
      filterList.querySelectorAll('.legend-item').forEach(b=>{
        b.classList.toggle('selected', (b.dataset.category||'all') === selectedFilter);
      });
    }

    function renderTeachingPage(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`); 
      if(!grid) return;
      grid.innerHTML='';

      const phonemeKey = displayMode === 'phonics' ? 'phonics' : 'phonemes';
      const phonemeClass = displayMode === 'phonics' ? 'is-phonics' : '';

      currentTopicData.forEach(w=>{
        const tags=w.tags||[];
        const badgeHTML = tags.map(t=>{ const info=tagInfo(t); return `<span class="category-tag ${info.className}">${info.name}</span>`; }).join(' ');
        const badges = `<div class="badges">${badgeHTML}</div>`;

        const tracks=w.graphemes.map(g=>{
          const len=String(g).length||1;
          const minCh = g==='-' ? 1 : Math.max(2, Math.min(8, len));
          return `minmax(${minCh}ch, max-content)`;
        }).join(' ');

        const gCells = w.graphemes.map((g,i)=>`
          <div class="grapheme-box box" role="gridcell">
            ${g}${w.hearts?.[i]?'<span class="heart-symbol">â¤</span>':''}
          </div>
        `).join('');

        const pCells = w[phonemeKey].map((p)=>`
          <div class="phoneme-box box ${phonemeClass}" role="gridcell">${String(p||'')}</div>
        `).join('');

        const card=`
          <article class="word-card" data-word="${(w.word||'').toLowerCase()}" data-tags="${tags.join(',')}">
            <header class="card-header">
              <div class="card-title"><span class="word-number">${w.number ?? ''}</span><span class="word-text">${w.word}</span></div>
              <button class="audio-button" onclick="speak('${(w.speak || w.word).replace(/'/g,"\\'")}')">ğŸ”Š</button>

            </header>
            <div class="card-body">
              ${badges}
              <div class="boxes-grid" role="grid" style="grid-template-columns:${tracks};grid-template-rows:repeat(2,auto);">
                ${gCells}
                ${pCells}
              </div>
              <div class="word-tips"><span class="tips-icon">ğŸ’¡</span><span>${w.hint||''}</span></div>
            </div>
          </article>
        `;
        grid.insertAdjacentHTML('beforeend',card);
      });
    }

    function applyFilters(contentId){
      const grid = document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const cards = grid.querySelectorAll('.word-card');
      if(selectedFilter === 'all'){
        cards.forEach(c=>c.classList.remove('hidden'));
        return;
      }
      cards.forEach(c=>{
        const tags = (c.getAttribute('data-tags')||'').split(',').filter(Boolean);
        c.classList.toggle('hidden', !tags.includes(selectedFilter));
      });
    }

    // ====== æœå°‹ï¼šè·¨ä¸»é¡Œå®šä½å–®å­— ======
    let WORD_INDEX = {}; // { wordLower: { slug, levelIndex } }
    function buildWordIndexFromAll(){
      WORD_INDEX = {};
      (CACHE.topics?.topics||[]).forEach(t=>{
        t.levels.forEach((lv, idx)=>{
          const items = CACHE.data[lv.src]?.items || [];
          items.forEach(w=>{
            const key = String(w.word||'').trim().toLowerCase();
            if(key && !WORD_INDEX[key]) WORD_INDEX[key] = { slug: t.slug, levelIndex: idx };
          });
        });
      });
    }
    function goToWord(wordRaw){
      const input = String(wordRaw||'').trim().toLowerCase();
      const msgEl = document.getElementById('searchMsg');
      if(!input){ msgEl.textContent='è«‹è¼¸å…¥å–®å­—'; return; }
      const hit = WORD_INDEX[input];
      if(!hit){ msgEl.textContent=`æ‰¾ä¸åˆ°ï¼š${wordRaw}`; return; }
      msgEl.textContent='';
      const pageId = `${hit.slug}_${hit.levelIndex+1}_Page`;
      window._pendingHighlight = input;
      showPage(pageId);
    }
    function initSearchBar(){
      const inp=document.getElementById('globalSearchInput');
      const btn=document.getElementById('globalSearchBtn');
      if(!inp||!btn) return;
      btn.addEventListener('click',()=>goToWord(inp.value));
      inp.addEventListener('keydown',(e)=>{ if(e.key==='Enter') goToWord(inp.value); });
    }
    function highlightIfPending(contentId){
      const target=(window._pendingHighlight||'').toLowerCase();
      if(!target) return;
      const grid=document.getElementById(`teaching-grid-${contentId}`);
      if(!grid) return;
      const card=grid.querySelector(`.word-card[data-word="${CSS.escape(target)}"]`);
      if(card){
        card.classList.add('search-hit');
        card.scrollIntoView({behavior:'smooth',block:'center'});
        setTimeout(()=>card.classList.remove('search-hit'),1600);
      }
      window._pendingHighlight='';
    }

    // ====== å°èˆªï¼šç”¨ label é¡¯ç¤ºï¼ˆä¾‹å¦‚ 1â€“10ã€11â€“20ï¼‰ ======
    function showPage(pageId){
      document.querySelectorAll('.page-section').forEach(p=>p.classList.remove('active'));
      const active = document.getElementById(pageId);
      if(!active) return;
      active.classList.add('active');
      window.scrollTo({ top: 0, behavior: 'smooth' });

      const m = pageId.match(/^(.+)_([12])_Page$/);
      if(!m) return; // å¯èƒ½æ˜¯ home
      const slug = m[1], levelIndex = Number(m[2])-1;
      const contentId = `${slug}_${levelIndex+1}_Content`;

      // æ‰¾åˆ°è©² level çš„ src
      const topic = (CACHE.topics?.topics||[]).find(x=>x.slug===slug);
      const lv = topic?.levels?.[levelIndex];
      if(!lv) return;

      // æŠ“è³‡æ–™ï¼ˆå¿«å–ï¼‰
      if(!CACHE.data[lv.src]){
        fetch(lv.src).then(r=>r.json()).then(json=>{
          CACHE.data[lv.src]=json;
          currentTopicData = json.items||[];
          initTopicPage(contentId);
        }).catch(e=>{
          console.error(e);
          document.getElementById(contentId).innerHTML = `<p style="color:#b91c1c">è¼‰å…¥å¤±æ•—ï¼š${lv.src}</p>`;
        });
      }else{
        currentTopicData = CACHE.data[lv.src].items||[];
        initTopicPage(contentId);
      }
    }
    window.showPage = showPage;

    function buildHomeAndSections(){
      const list = document.getElementById('topicList');
      const main = document.querySelector('main');

      (CACHE.topics?.topics||[]).forEach(t=>{
        // é¦–é ï¼šç‚ºæ¯å€‹ level å»ºä¸€å€‹æŒ‰éˆ•ï¼Œé¡¯ç¤º labelï¼ˆä¾‹å¦‚ 1â€“10ï¼‰
        t.levels.forEach((lv, idx)=>{
          const label = lv.label || `-${idx+1}`;
          list.insertAdjacentHTML('beforeend', `
            <li class="topic-list-item" onclick="showPage('${t.slug}_${idx+1}_Page')">
              ${t.title}ï¼ˆ${label}ï¼‰
            </li>
          `);
        });

        // å…§å®¹é ï¼šæ¨™é¡Œä¹Ÿé¡¯ç¤º label
        const l1 = t.levels[0]?.label || '-1';
        const l2 = t.levels[1]?.label || '-2';

        main.insertAdjacentHTML('beforeend', `
          <section id="${t.slug}_1_Page" class="page-section">
            <button class="back-button" onclick="showPage('homePage')"><i class="fa-solid fa-arrow-left"></i>è¿”å›ç›®éŒ„</button>
            <h1>${t.title}ï¼ˆ${l1}ï¼‰è²éŸ³å°ç…§è¡¨</h1>
            <div id="${t.slug}_1_Content"></div>
          </section>
          <section id="${t.slug}_2_Page" class="page-section">
            <button class="back-button" onclick="showPage('homePage')"><i class="fa-solid fa-arrow-left"></i>è¿”å›ç›®éŒ„</button>
            <h1>${t.title}ï¼ˆ${l2}ï¼‰è²éŸ³å°ç…§è¡¨</h1>
            <div id="${t.slug}_2_Content"></div>
          </section>
        `);
      });
    }

    // ====== å•Ÿå‹•ï¼šè®€ topics â†’ å»ºé é¢ â†’ é æŠ“è³‡æ–™ï¼ˆä¾›æœå°‹ï¼‰â†’ å»ºç´¢å¼• â†’ é¡¯ç¤ºé¦–é  ======
    document.addEventListener('DOMContentLoaded', async ()=>{
      initSearchBar();
      try{
        const resp = await fetch(TOPICS_URL);
        CACHE.topics = await resp.json();
      }catch(e){
        console.error(e);
        document.getElementById('topicList').innerHTML = '<li class="topic-list-item" style="color:#b91c1c">è®€å– topics.json å¤±æ•—</li>';
        return;
      }
      buildHomeAndSections();

      // é æŠ“æ‰€æœ‰ level çš„ JSONï¼ˆç‚ºäº†æœå°‹ï¼‰ï¼Œå¤±æ•—ä¸æ“‹ç•«é¢
      await Promise.allSettled(
        (CACHE.topics.topics||[]).flatMap(t => t.levels.map(lv =>
          fetch(lv.src).then(r=>r.json()).then(j=>{ CACHE.data[lv.src]=j; })
        ))
      );
      buildWordIndexFromAll();

      showPage('homePage');
    });
  </script>
</body>
</html>

